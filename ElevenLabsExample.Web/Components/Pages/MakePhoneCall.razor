@page "/call"
@using System.ComponentModel.DataAnnotations
@using ElevenLabsExample.Common
@attribute [StreamRendering(true)]
@attribute [OutputCache(Duration = 5)]

@inject PhoneCallApiClient PhoneCallApiClient

<PageTitle>Make Phone Call</PageTitle>

<h1>Make Phone Call</h1>

<p>This component demonstrates showing data loaded from a backend API service.</p>

<EditForm Model="@formData" OnValidSubmit="@HandleValidSubmit" FormName="MakePhoneCall">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="mb-3">
        <label class="form-label">Carer Name</label>
        <InputText class="form-control" @bind-Value="formData.CarerFirstName" />
    </div>
    <div class="mb-3">
        <label class="form-label">Phone Number</label>
        <InputNumber class="form-control" @bind-Value="formData.PhoneNumber" />
    </div>
    <div class="mb-3">
        <label class="form-label">Visit Date</label>
        <InputDate class="form-control" @bind-Value="formData.VisitDate" />
    </div>
    <div class="mb-3">
        <label class="form-label">Visit Time</label>
        <InputNumber class="form-control" @bind-Value="formData.VisitTime" />
    </div>
    <div class="mb-3">
        <label class="form-label">Duration</label>
        <InputNumber class="form-control" @bind-Value="formData.VisitDurationMinutes" />
    </div>
    <div class="mb-3">
        <label class="form-label">Duration</label>
        <InputText class="form-control" @bind-Value="formData.ClientPostcode" />
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
</EditForm>

@code {
    private MakePhoneCallFormData formData = new();


    private async Task HandleValidSubmit()
    {
        var dto = new CreatePhoneCallDto(
            formData.CarerFirstName,
            formData.PhoneNumber,
            formData.VisitDate,
            formData.VisitDurationMinutes,
            formData.ClientPostcode
        );

        var success = await PhoneCallApiClient.MakePhoneCallAsync(dto);

        if (success)
        {
            // minimal UX feedback: clear form (optional)
            formData = new MakePhoneCallFormData();
            StateHasChanged();
        }
        else
        {
            // TODO: surface error to user (toast/validation summary)
        }
    }

    public class MakePhoneCallFormData
    {
        // [Required]
        public string CarerFirstName { get; set; } = string.Empty;

        // [Required, Phone]
        public int PhoneNumber { get; set; }

        [Required]
        public DateOnly VisitDate { get; set; } = DateOnly.FromDateTime(DateTime.Now);

        [Required]
        public int VisitTime { get; set; }

        [Required]
        public int VisitDurationMinutes { get; set; }

        // [Required]
        public string ClientPostcode { get; set; } = string.Empty;
    }
}
